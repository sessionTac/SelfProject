<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.springboot.osbulkparts.dao.report.ReportOrderDetailInfoDao">
  <resultMap id="BaseResultMap" type="cn.springboot.osbulkparts.entity.ReportOrderDetailInfoEntity">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 22 20:45:09 CST 2019.
    -->
    <id column="id" jdbcType="VARCHAR" property="id" />
    <result column="order_code" jdbcType="VARCHAR" property="orderCode" />
    <result column="order_code_desc" jdbcType="VARCHAR" property="orderCodeDesc" />
    <result column="order_amount" jdbcType="DECIMAL" property="orderAmount" />
    <result column="order_date" jdbcType="VARCHAR" property="orderDate" />
    <result column="order_unit" jdbcType="VARCHAR" property="orderUnit" />
    <result column="order_id" jdbcType="VARCHAR" property="orderId" />
    <result column="order_id_item" jdbcType="VARCHAR" property="orderIdItem" />
    <result column="material_code" jdbcType="VARCHAR" property="materialCode" />
    <result column="material_desc_cn" jdbcType="VARCHAR" property="materialDescCn" />
    <result column="material_desc_en" jdbcType="VARCHAR" property="materialDescEn" />
    <result column="material_desc_rn" jdbcType="VARCHAR" property="materialDescRn" />
    <result column="material_unit" jdbcType="VARCHAR" property="materialUnit" />
    <result column="material_amount" jdbcType="DECIMAL" property="materialAmount" />
    <result column="material_category" jdbcType="VARCHAR" property="materialCategory" />
    <result column="material_relation" jdbcType="VARCHAR" property="materialRelation" />
    <result column="material_relation_unit" jdbcType="VARCHAR" property="materialRelationUnit" />
    <result column="material_relation_quantity" jdbcType="DECIMAL" property="materialRelationQuantity" />
    <result column="material_minpackage_type" jdbcType="VARCHAR" property="materialMinpackageType" />
    <result column="material_minpackage_amt" jdbcType="DECIMAL" property="materialMinpackageAmt" />
    <result column="material_minpackage_totalamt" jdbcType="DECIMAL" property="materialMinpackageTotalamt" />
    <result column="material_tax_price" jdbcType="DECIMAL" property="materialTaxPrice" />
    <result column="material_tax_totalprice" jdbcType="DECIMAL" property="materialTaxTotalprice" />
    <result column="material_vat_price" jdbcType="DECIMAL" property="materialVatPrice" />
    <result column="material_supplier_no" jdbcType="VARCHAR" property="materialSupplierNo" />
    <result column="tax" jdbcType="DECIMAL" property="tax" />
    <result column="material_vat_totalprice" jdbcType="DECIMAL" property="materialVatTotalprice" />
    <result column="material_rate" jdbcType="DECIMAL" property="materialRate" />
    <result column="material_currency" jdbcType="VARCHAR" property="materialCurrency" />
    <result column="country_code" jdbcType="VARCHAR" property="countryCode" />
    <result column="confirm_status" jdbcType="VARCHAR" property="confirmStatus" />
    <result column="order_out_total_amount" jdbcType="DECIMAL" property="orderOutTotalAmount" />
    <result column="mater_out_total_amount" jdbcType="DECIMAL" property="materOutTotalAmount" />
    <result column="residual_amount" jdbcType="DECIMAL" property="residualAmount" />
    <result column="trim_amount" jdbcType="DECIMAL" property="trimAmount" />
    <result column="stock_amount" jdbcType="DECIMAL" property="stockAmount" />
    <result column="differ_amount" jdbcType="DECIMAL" property="differAmount" />
    <result column="take_over_amount" jdbcType="DECIMAL" property="takeOverAmount" />
    <result column="delivery_amount" jdbcType="DECIMAL" property="deliveryAmount" />
    <result column="surplus_amount" jdbcType="DECIMAL" property="surplusAmount" />
    <result column="amount_total" jdbcType="DECIMAL" property="amountTotal" />
    <result column="date_flag" jdbcType="VARCHAR" property="dateFlag" />
    <result column="data_role_at" jdbcType="VARCHAR" property="dataRoleAt" />
    <result column="is_balance" jdbcType="INTEGER" property="isBalance" />
    <result column="order_detail_type" jdbcType="VARCHAR" property="orderDetailType" />
    <result column="create_user" jdbcType="VARCHAR" property="createUser" />
    <result column="create_time" jdbcType="VARCHAR" property="createTime" />
    <result column="update_user" jdbcType="VARCHAR" property="updateUser" />
    <result column="update_time" jdbcType="VARCHAR" property="updateTime" />
    <result column="is_delete" jdbcType="INTEGER" property="isDelete" />
    <result column="version" jdbcType="INTEGER" property="version" />
    <!--超发数量-->
    <association property="supperAmountQut"
                 javaType="cn.springboot.osbulkparts.entity.TMaterialRecordInfoEntity">
      <result property="supperAmount" column="supper_amount"/>
    </association>
    <!--订单型号单位-->
    <association property="dictOrderUnit"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="order_unit"/>
      <result property="name" column="dictOrderUnit"/>
    </association>
    <!--物料单位-->
    <association property="dictMaterialUnit"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="material_unit"/>
      <result property="name" column="dictMaterialUnit"/>
    </association>
    <!--物料类别-->
    <association property="dictMaterialCategory"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="material_category"/>
      <result property="name" column="dictMaterialCategory"/>
    </association>
    <!--换算后单位-->
    <association property="dictRelationUnit"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="material_relation_unit"/>
      <result property="name" column="dictRelationUnit"/>
    </association>
    <!--最小包装类型-->
    <association property="dictMinPackageType"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="material_minpackage_type"/>
      <result property="name" column="dictMinPackageType"/>
    </association>
    <!--币种-->
    <association property="dictMaterialCurrency"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="material_currency"/>
      <result property="name" column="dictMaterialCurrency"/>
    </association>
    <!--国家标志-->
    <association property="dictCountryCode"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="country_code"/>
      <result property="name" column="dictCountryCode"/>
    </association>
    <!--状态-->
    <association property="dictConfirmStatus"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="confirm_status"/>
      <result property="name" column="dictConfirmStatus"/>
    </association>
    <!--订单详细类型-->
    <association property="dictOrderDetailType"
                 javaType="cn.springboot.osbulkparts.entity.TDictDataEntity">
      <result property="value" column="order_detail_type"/>
      <result property="name" column="dictOrderDetailType"/>
    </association>
    <!--供应商-->
    <association property="mSupplierInfoEntity"
                 javaType="cn.springboot.osbulkparts.entity.MSupplierInfoEntity">
      <result property="supplierCode" column="material_supplier_no"/>
      <result property="supplierNameCn" column="supplierName"/>
    </association>
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Sat Jun 22 20:45:09 CST 2019.
    -->
    id, order_code, order_code_desc, order_amount, order_date, order_unit, order_id, 
    order_id_item, material_code, material_desc_cn, material_desc_en, material_desc_rn, 
    material_unit, material_amount, material_category, material_relation, material_relation_unit, 
    material_relation_quantity, material_minpackage_type, material_minpackage_amt, material_minpackage_totalamt, 
    material_tax_price, material_tax_totalprice, material_vat_price, material_vat_totalprice, material_supplier_no,tax,
    material_rate, material_currency, country_code, confirm_status, order_out_total_amount, 
    mater_out_total_amount, residual_amount, trim_amount, stock_amount, differ_amount, 
    take_over_amount, delivery_amount, surplus_amount, date_flag,data_role_at, is_balance, order_detail_type,create_user, create_time,
    update_user, update_time, is_delete, version
  </sql>
  <select id="getReportOrderDetailInfo" parameterType="cn.springboot.osbulkparts.entity.ReportOrderDetailInfoEntity" resultMap="BaseResultMap">
		SELECT
			detailInfo.material_code,
			detailInfo.material_desc_cn,
			detailInfo.material_desc_en,
			detailInfo.material_desc_rn,
			material.material_amount,
			material.material_unit,
			t3.`name` AS dictMaterialUnit,
			material.supplier_code as material_supplier_no,
			t12.supplier_name_cn as supplierName,
<!-- 			t0.order_date, -->
            detailInfo.material_minpackage_amt,
            detailInfo.order_date,
            detailInfo.order_amount,
			t0.amount_total
		FROM
			t_order_detail_info detailInfo
		LEFT JOIN m_material_info material ON detailInfo.material_code = material.material_code
		AND detailInfo.order_code = material.material_order_code
		AND material.is_delete = 0
		LEFT JOIN t_dict_data_cn AS t3 ON material.material_unit = t3.`value`
		AND t3.dict_type_code = 'unit'
		AND t3.delete_flg = 0
		LEFT JOIN m_supplier_info AS t12 ON detailInfo.material_supplier_no = t12.supplier_code
		AND t12.is_delete = 0,
		 (
			SELECT
				t1.material_code,
				GROUP_CONCAT(
					SUBSTR(t1.order_date FROM 1 FOR 8),
					'||',
					t1.order_amount
				) AS order_date,
				SUM(t1.order_amount) AS amount_total
			FROM
				t_order_detail_info t1
			WHERE
				is_delete = 0
			GROUP BY
				t1.material_code
			ORDER BY
				t1.material_code,
				t1.order_date
		) t0
		WHERE
			detailInfo.material_code = t0.material_code
	    and detailInfo.is_delete = 0
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(orderCode)">
	      <bind name="orderCode_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(orderCode)"/>
	      AND detailInfo.order_code LIKE #{orderCode_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(orderDateStart)">
	      AND detailInfo.order_date &gt;= #{orderDateStart,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(orderDateEnd)">
	      AND detailInfo.order_date &lt;= #{orderDateEnd,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(materialCode)">
	      <bind name="materialCode_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(materialCode)"/>
	      AND detailInfo.material_code LIKE #{materialCode_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(confirmStatus)">
	      AND detailInfo.confirm_status = #{confirmStatus,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(materialCategory)">
	      AND detailInfo.material_category = #{materialCategory,jdbcType=VARCHAR}
	    </if>
	    <if test="isBalance != null">
	      AND detailInfo.is_balance = #{isBalance,jdbcType=INTEGER}
	    </if>
	    <if test="dateFlag != null">
	      AND detailInfo.date_flag = #{dateFlag,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(dataRoleAt)">
	      AND detailInfo.data_role_at = #{dataRoleAt,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(orderDetailType)">
	      AND detailInfo.order_detail_type = #{orderDetailType,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(orderCodeDesc)">
	      <bind name="orderCodeDesc_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(orderCodeDesc)"/>
	      AND detailInfo.order_code_desc LIKE #{orderCodeDesc_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(orderId)">
	      <bind name="orderId_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(orderId)"/>
	      AND detailInfo.order_id LIKE #{orderId_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(materialDescCn)">
	      <bind name="materialDescCn_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(materialDescCn)"/>
	      AND detailInfo.material_desc_cn LIKE #{materialDescCn_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(materialDescEn)">
	      <bind name="materialDescEn_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(materialDescEn)"/>
	      AND detailInfo.material_desc_en LIKE #{materialDescEn_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(materialDescRn)">
	      <bind name="materialDescRn_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(materialDescRn)"/>
	      AND detailInfo.material_desc_rn LIKE #{materialDescRn_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(createUser)">
	      <bind name="createUser_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(createUser)"/>
	      AND detailInfo.create_user LIKE #{createUser_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(createTimeStart)">
	      AND detailInfo.create_time &gt;= #{createTimeStart,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(createTimeEnd)">
	      AND detailInfo.create_time &lt;= #{createTimeEnd,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(updateUser)">
	      <bind name="updateUser_like" value="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@toLike(updateUser)"/>
	      AND detailInfo.update_user LIKE #{updateUser_like,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(updateTimeStart)">
	      AND detailInfo.update_time &gt;= #{updateTimeStart,jdbcType=VARCHAR}
	    </if>
	    <if test="@cn.springboot.osbulkparts.common.utils.CommonSqlUtils@isNotBlank(updateTimeEnd)">
	      AND detailInfo.update_time &lt;= #{updateTimeEnd,jdbcType=VARCHAR}
	    </if>
	    <if test="id != null">
	      AND detailInfo.id = #{id,jdbcType=VARCHAR}
	    </if>
        GROUP BY detailInfo.material_code
	    order by detailInfo.order_date,detailInfo.material_supplier_no
  </select>
</mapper>